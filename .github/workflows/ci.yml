name: CI

on:
  pull_request:
  push:
    branches:
      - master

jobs:
  lockfile-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Verify lockfile is in sync
        shell: bash
        run: npm ci --no-fund --no-audit

  python-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install tooling
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install requests pytest ruff check-jsonschema

      - name: Lint Python
        shell: bash
        run: python -m ruff check scripts/ tests/

      - name: Verify metadata versions match latest release tag
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
        run: |
          set -euo pipefail
          tag_ref="HEAD"
          if [ "${EVENT_NAME}" = "pull_request" ] && [ -n "${PR_BASE_SHA}" ]; then
            tag_ref="${PR_BASE_SHA}"
          fi
          python scripts/check-version-sync.py --reference "${tag_ref}"

      - name: Run tests
        shell: bash
        run: python -m pytest -q tests/

      - name: Validate action metadata
        shell: bash
        run: python -m check_jsonschema --schemafile https://json.schemastore.org/github-action.json action.yml
